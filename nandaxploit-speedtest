#!/bin/bash

# NandaXploit SpeedTest Tool
# Version: 2.0 (Fixed)
# GitHub: https://github.com/wordhubungixkm/nandaxploit-speedtest

# Colors
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
PURPLE='\033[1;35m'
NC='\033[0m'

# Check Termux environment
check_termux() {
    if ! [ -x "$(command -v pkg)" ]; then
        echo -e "${RED}[!] Error: This script must be run in Termux${NC}"
        exit 1
    fi
}

# Show cool header
show_header() {
    clear
    echo -e "${RED}"
    cat << "EOF"
  _   _           _            __  ______  _       _ _ 
 | \ | |         | |          / _| | ___ \(_)     (_) |
 |  \| | __ _  __| | ___  ___| |_  | |_/ / _ _ __ _| |_ 
 | . \ |/ _` |/ _` |/ _ \/ _ \  _| |  __/ | | '__| | __|
 | |\  | (_| | (_| |  __/  __/ |   | |    | | |  | | |_ 
 \_| \_/\__,_|\__,_|\___|\___|_|   \_|    |_|_|  |_|\__|
EOF
    echo -e "${CYAN}"
    echo "         === Internet Speed Test Tool ==="
    echo -e "${NC}"
    echo -e "${YELLOW}Version 2.0 | Fixed Version | By NandaXploit${NC}"
    echo ""
}

# Animated spinner
spinner() {
    local pid=$!
    local delay=0.15
    local spinstr='|/-\\'
    while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

# Install required packages
install_deps() {
    echo -e "${YELLOW}[*] Checking dependencies...${NC}"
    
    # Update packages first
    pkg update -y > /dev/null 2>&1
    
    if ! command -v python &> /dev/null; then
        echo -e "${CYAN}[+] Installing Python...${NC}"
        pkg install python -y > /dev/null 2>&1 || {
            echo -e "${RED}[!] Failed to install Python${NC}"
            exit 1
        }
    fi
    
    if ! command -v speedtest-cli &> /dev/null; then
        echo -e "${CYAN}[+] Installing speedtest-cli...${NC}"
        pip install --upgrade pip > /dev/null 2>&1
        pip install speedtest-cli > /dev/null 2>&1 || {
            echo -e "${RED}[!] Failed to install speedtest-cli${NC}"
            exit 1
        }
    fi
}

# Run the actual speed test
run_test() {
    echo -e "${YELLOW}[*] Starting speed test...${NC}"
    echo ""
    
    # Test internet connection first
    echo -ne "${CYAN}[+] Checking internet connection...${NC}"
    if ! ping -c 1 google.com &> /dev/null; then
        echo -e "\r${RED}[!] No internet connection!${NC}"
        exit 1
    fi
    echo -e "\r${CYAN}[+] Internet connection: ${GREEN}OK${NC}"
    
    # Run speedtest
    echo -ne "${CYAN}[+] Measuring speeds (may take 30 seconds)...${NC}"
    result=$(speedtest-cli --simple 2>&1) & spinner
    
    if [[ $? -ne 0 ]]; then
        echo -e "\r${RED}[!] Speed test failed!${NC}"
        echo -e "${YELLOW}[*] Error details:${NC}"
        echo "$result"
        exit 1
    fi
    
    # Parse results
    download=$(echo "$result" | grep Download | awk '{printf "%.2f", $2}')
    upload=$(echo "$result" | grep Upload | awk '{printf "%.2f", $2}')
    ping=$(echo "$result" | grep Ping | awk '{printf "%.0f", $2}')
    
    # Display results
    echo -e "\n${PURPLE}╔════════════════════════════════════╗"
    echo -e "║          ${CYAN}NandaXploit Results${PURPLE}          ║"
    echo -e "╠════════════════════════════════════╣"
    printf "║ ${CYAN}%-9s${NC}: ${YELLOW}%-18s${PURPLE} ║\n" "Download" "${download} Mbit/s"
    printf "║ ${CYAN}%-9s${NC}: ${YELLOW}%-18s${PURPLE} ║\n" "Upload" "${upload} Mbit/s"
    printf "║ ${CYAN}%-9s${NC}: ${YELLOW}%-18s${PURPLE} ║\n" "Ping" "${ping} ms"
    echo -e "╚════════════════════════════════════╝${NC}"
    
    echo -e "\n${GREEN}[✓] Speed test completed successfully!${NC}"
    echo -e "${BLUE}GitHub: https://github.com/wordhubungixkm/nandaxploit-speedtest}"
}

# Main function
main() {
    check_termux
    show_header
    install_deps
    run_test
}

# Start the script
main
