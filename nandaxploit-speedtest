#!/bin/bash

# NandaXploit SpeedTest Tool
# Version: 1.1
# GitHub: https://github.com/[yourusername]/nandaxploit-speedtest

# Colors
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
PURPLE='\033[1;35m'
NC='\033[0m'

# Check if running in Termux
check_termux() {
    if ! [ -d "/data/data/com.termux/files/usr" ]; then
        echo -e "${RED}[!] Error: This script must be run in Termux${NC}"
        exit 1
    fi
}

show_header() {
    clear
    echo -e "${RED}"
    echo "  _   _           _            __  ______  _       _ _ "
    echo " | \ | |         | |          / _| | ___ \(_)     (_) |"
    echo " |  \| | __ _  __| | ___  ___| |_  | |_/ / _ _ __ _| |_ "
    echo " | . \ |/ _\` |/ _\` |/ _ \/ _ \  _| |  __/ | | '__| | __|"
    echo " | |\  | (_| | (_| |  __/  __/ |   | |    | | |  | | |_ "
    echo " \_| \_/\__,_|\__,_|\___|\___|_|   \_|    |_|_|  |_|\__|"
    echo -e "${CYAN}"
    echo "         === Internet Speed Test Tool ==="
    echo -e "${NC}"
    echo -e "${YELLOW}Version 1.1 | By NandaXploit${NC}"
    echo ""
}

spinner() {
    local pid=$!
    local delay=0.1
    local spinstr='|/-\'
    while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

install_dependencies() {
    echo -e "${YELLOW}[*] Checking dependencies...${NC}"
    
    if ! command -v python &> /dev/null; then
        echo -e "${CYAN}[+] Installing Python...${NC}"
        pkg update -y > /dev/null 2>&1
        pkg install python -y > /dev/null 2>&1 || {
            echo -e "${RED}[!] Failed to install Python${NC}"
            exit 1
        }
    fi
    
    if ! command -v speedtest-cli &> /dev/null; then
        echo -e "${CYAN}[+] Installing speedtest-cli...${NC}"
        pip install --upgrade pip > /dev/null 2>&1
        pip install speedtest-cli > /dev/null 2>&1 || {
            echo -e "${RED}[!] Failed to install speedtest-cli${NC}"
            exit 1
        }
    fi
}

run_speedtest() {
    # Ping test
    echo -ne "${CYAN}[+] Measuring ping to google.com...${NC}"
    ping -c 3 google.com > /tmp/ping.txt 2>&1 &
    spinner
    
    if [ $? -ne 0 ]; then
        echo -e "\r${RED}[!] Ping test failed (no internet connection?)${NC}"
        return 1
    fi
    
    ping_result=$(grep "min/avg/max" /tmp/ping.txt | awk -F '/' '{print $5}' | cut -d '.' -f1)
    echo -e "\r${CYAN}[+] Ping: ${YELLOW}${ping_result} ms${NC}"
    
    # Speedtest
    echo -ne "${CYAN}[+] Measuring download/upload speed...${NC}"
    speedtest-cli --simple > /tmp/speedtest.txt 2>&1 &
    spinner
    
    if [ $? -ne 0 ]; then
        echo -e "\r${RED}[!] Speedtest failed (server unavailable)${NC}"
        return 1
    fi
    
    download=$(grep "Download" /tmp/speedtest.txt | awk '{printf "%.2f", $2}')
    upload=$(grep "Upload" /tmp/speedtest.txt | awk '{printf "%.2f", $2}')
    ping=$(grep "Ping" /tmp/speedtest.txt | awk '{printf "%.0f", $2}')
    
    # Display results with proper formatting
    echo -e "\n${PURPLE}╔════════════════════════════════════╗"
    echo -e "║          ${CYAN}NandaXploit Results${PURPLE}          ║"
    echo -e "╠════════════════════════════════════╣"
    printf "║ ${CYAN}%-9s${NC}: ${YELLOW}%-18s${PURPLE} ║\n" "Download" "${download} Mbit/s"
    printf "║ ${CYAN}%-9s${NC}: ${YELLOW}%-18s${PURPLE} ║\n" "Upload" "${upload} Mbit/s"
    printf "║ ${CYAN}%-9s${NC}: ${YELLOW}%-18s${PURPLE} ║\n" "Ping" "${ping} ms"
    echo -e "╚════════════════════════════════════╝${NC}"
}

main() {
    check_termux
    show_header
    install_dependencies
    
    echo -e "${YELLOW}[*] Starting internet speed test...${NC}"
    echo ""
    
    if ! run_speedtest; then
        echo -e "\n${RED}[!] Speed test encountered errors${NC}"
        echo -e "${YELLOW}[*] Please check your internet connection and try again${NC}"
        exit 1
    fi
    
    echo -e "\n${GREEN}[✓] Speed test completed successfully!${NC}"
    echo -e "${BLUE}GitHub: https://github.com/wordhubungixkm/nandaxploit-speedtest${NC}"
    echo ""
    
    # Clean up
    rm -f /tmp/ping.txt /tmp/speedtest.txt 2>/dev/null
}

main
